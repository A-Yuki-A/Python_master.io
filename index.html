const $ = id => document.getElementById(id);

let questions = [];
let index = 0;
let level = 1;

/* ===== JSON読み込み ===== */
fetch("questions.json")
  .then(res => res.json())
  .then(data => {
    questions = data;
  });

/* ===== 冒険開始 ===== */
$("startAdventureBtn").addEventListener("click", () => {
  const name = $("heroName").value.trim();
  if (!name) {
    alert("勇者の名前を入力してください");
    return;
  }

  $("topScreen").classList.add("hidden");
  $("gameScreen").classList.remove("hidden");

  showQuestion();
});

/* ===== 問題表示 ===== */
function showQuestion(){
  const q = questions[index];

  $("qidPill").textContent = q.id;
  $("stageBadge").textContent = "ステージ：" + q.stageName;
  $("talkText").textContent = q.preTalk;
  $("talkImage").src = q.preImage;
  $("promptText").textContent = q.prompt;
  $("pythonCode").textContent = q.pythonCode;
  $("refCode").textContent = q.refCode;

  $("choicesForm").innerHTML = "";
  q.choices.forEach((c,i)=>{
    const label = document.createElement("label");
    label.innerHTML = `
      <input type="radio" name="choice" value="${i}">
      ${c}
    `;
    $("choicesForm").appendChild(label);
  });
}

/* ===== 判定 ===== */
$("checkBtn").addEventListener("click", ()=>{
  const checked = document.querySelector("input[name='choice']:checked");
  if (!checked) return;

  const q = questions[index];
  if (Number(checked.value) === q.answerIndex){
    level += 5;
    $("levelText").textContent = "Lv." + level;
    $("resultMsg").textContent = "正解！";
    $("explainText").textContent = q.explain;

    setTimeout(()=>{
      index++;
      if(index < questions.length){
        showQuestion();
      }
    },1200);
  }else{
    $("resultMsg").textContent = "不正解…";
    $("explainText").textContent = q.explain;
  }
});
